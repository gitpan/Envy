#!/bin/ksh
USAGE='usage: [-v] [-e envy1 envy2 ...] [-s <shell cmd> ...]'

if [ x$ENVY_VERSION != x ]; then
  echo
  echo '*** ERROR: Envy is already running!'
  echo
  echo 'To test, please use this idiom:'
  echo "  'env -i $0 ...'"
  echo
  exit
fi

#INITIAL_ENV#

if [ x$LOGNAME == x  ]; then
  # cron sets up LOGNAME automatically but 'env -i' does not.
  # Here we try to set it to something reasonable:
  LOGNAME=`#WHOAMI#`; export LOGNAME
  # Probably need this too?
  HOME=/home/$LOGNAME; export HOME
fi

typeset -i i
typeset -i j
if [[ $# = 0 ]]; then
    echo $USAGE
    break
fi
  
ENVY=`dirname $0`/envy.pl
test -x $ENVY || echo Envy not found at $ENVY: PANIC

v=0
toload=#STARTUP#

while [[ $1 = -* ]];
do
case $1 in

-s) while [[ $2 != -* && $# > 1 ]];
    do 
	commands[$i]=${commands[$i]}" "$2
	shift
    done
    i=$i+1;;

-m|-e) while [[ $2 != -* && $# > 1 ]];
    do 
	if [ "$2" != #STARTUP# ]; then
	    toload="$toload $2"
	fi
	shift
    done;;

-v) v=1;;

*)  echo "UNKNOWN OPTION -"$1 
    echo $USAGE
    break
esac

if [[ $# > 0 ]];  then
    shift
fi
done

ENVY_CONTEXT=${commands[0]}
export ENVY_CONTEXT
eval `$ENVY load $toload`
if [ $v -eq 1 ]; then echo 'eval `'"$ENVY load $toload"'`'; fi

j=$i
i=0
while [[ $i < $j ]];
do
    if [ $v -eq 1 ]; then echo ${commands[$i]}; fi
    ${commands[$i]} 
    i=$i+1
done
